(function(a){a.widget("lws.lws_autocomplete",{options:{css:"",cssColor:"",readOnly:true,sharedElt:undefined,sharedSource:"source",sharedData:"lws_autocomplete"},value:function(b){if(b===undefined){return this._getOption().value}var c=a.grep(this.remote.concat(this.local()),function(d){return d.value==b});if(c.length>0){this.input.val(this._setOption(c[0]).text())}else{this.input.val(b);this.element.empty();this.element.val(b)}},local:function(b){if(b!==undefined){if(!Array.isArray(b)){b=Object.keys(b).map(function(c){return b[c]})}this.options.sharedElt.data(this.options.sharedData,b)}return this.options.sharedElt.data(this.options.sharedData)},_create:function(){var b="lws-autocomplete";if(this.element.data("class")!=undefined){b+=(" "+this.element.data("class"))}this.ajax=(this.element.data("ajax")!=undefined?this.element.data("ajax"):undefined);this.wrapper=a("<div>").addClass(b).insertAfter(this.element);this.textbox=a("<div>").appendTo(this.wrapper);if(this.options.css!=""){this.wrapper.addClass(this.options.css)}if(this.options.sharedElt==undefined){this.options.sharedElt=this.element}this.local([]);this.remote=[];this.lastTerm="";this.minSearch=(this.element.data("minsearch")!=undefined?this.element.data("minsearch"):3);this.minOption=(this.element.data("minoption")!=undefined?this.element.data("minoption"):0);this.spec=this.element.data("spec");this.element.hide();this._grabOptions();this._createAutocomplete();this._createShowAllButton();this._on(true,this.element,{change:function(){var c=this._getOption();if(this.input.val()!=c.label){this.input.val(this._setOption(c).text())}}})},_createAutocomplete:function(){var b={source:a.proxy(this,"_source")};if(this.element.data("delay")!=undefined){b.delay=this.element.data("delay")}else{if(this.ajax==undefined){b.delay=0}}if(this.element.data("minlength")!=undefined){b.minLength=this.element.data("minlength")}else{if(this.ajax==undefined){b.minLength=0}}this.input=a("<input>").appendTo(this.textbox).val(this._getOption().label).attr("title","").addClass("lws-autocomplete-input ui-widget ui-widget-content ui-state-default ui-corner-left").autocomplete(b).tooltip({tooltipClass:"lws-tooltip lws-autocomplete-tooltip"});if(this.element.data("name")!=undefined){this.input.attr("name",this.element.data("name"))}if(this.element.data("placeholder")!=undefined){this.input.attr("placeholder",this.element.data("placeholder"))}this.input.data("ui-autocomplete")._renderItem=this._renderItem;this.input.data("ui-autocomplete")._resizeMenu=function(){var c=this.menu.element;c.outerWidth(this.element.outerWidth())};this._on(this.input,{autocompleteselect:"_apply",autocompletechange:"_removeIfInvalid",autocompletefocus:"_focusItem",autocompleteopen:"_shiftWidget"})},_createShowAllButton:function(){var c=this.input,d=false;var e="Show All Items";if(typeof lws_autocomplete_localize!=="undefined"){e=lws_autocomplete_localize.btnTitle}var b=a("<a>").attr("tabIndex",-1).attr("title",e).tooltip().appendTo(this.wrapper).removeClass("ui-corner-all").addClass("lws-autocomplete-toggle lws-icon-select_arrow_down");if(this.options.cssColor!=""){b.addClass(this.options.cssColor)}b.on("mousedown",function(){d=c.autocomplete("widget").is(":visible")});b.on("click",function(){c.trigger("focus");if(d){return}var f=c.autocomplete("option","minLength");c.autocomplete("option","minLength",0);c.autocomplete("search","");c.autocomplete("option","minLength",f)})},_shiftWidget:function(){var b=this.input.autocomplete("widget").offset();this.input.autocomplete("widget").offset({top:(b.top+2),left:(b.left-2)})},_apply:function(b,c){this.input.val(this._setOption(c.item).text());return false},_focusItem:function(b,c){return false},_grabOptions:function(){if(this.options.sharedElt.data(this.options.sharedSource)!=undefined){this.local(lwsBase64.toObj(this.options.sharedElt.data(this.options.sharedSource)))}else{var b=[];this.element.children("option").each(function(){var d=a(this);var c={value:d.val(),label:d.html()};if(d.data("detail")!=undefined){c.detail=d.data("detail")}b.push(c)});this.local(b)}},_getOption:function(){var b=this.element.val();var c=a.grep(this.remote.concat(this.local()),function(d){return d.value==b});return(c.length>0?c[0]:{value:"",label:""})},_setOption:function(c){var b=this.element.val();this.element.empty();var d=a("<option>").attr("value",c.value).html(c.label).attr("selected","selected");this.element.append(d);this.element.val(c.value);if(b!=this.element.val()){this.element.trigger("change")}return d},_source:function(d,b){if(this.ajax!=undefined){if(d.term.length>=this.minSearch){this._sourceRemote(d,b)}else{var c=this._filterLocal(d);if(c.length<=this.minOption){this._sourceRemote(d,b)}else{b(c)}}}else{b(this._filterLocal(d))}},_filterLocal:function(b){var c=new RegExp(a.ui.autocomplete.escapeRegex(b.term),"i");return a.map(this.local(),function(d){if(d.value&&(!b.term||c.test(d.label))){return d}})},_sourceRemote:function(e,b){if(this.lastTerm.length>0&&e.term.indexOf(this.lastTerm)>=0){var f=new RegExp(a.ui.autocomplete.escapeRegex(e.term),"i");b(a.map(this.remote,function(g){if(g.value&&(!e.term||f.test(g.label))){return g}}))}else{var c={action:this.ajax,term:e.term};if(this.spec!=undefined){c.spec=this.spec}var d=this;a.getJSON(lws_ajax_url,c,function(g){d.remote=[];if(null==g){d._tooltip("Autocomplete ressource error.")}else{if(0===g){d._tooltip("Autocomplete action not found.")}else{a.each(g,function(h,i){d.remote.push(i)})}}b(d.remote);d.lastTerm=e.term}).fail(function(h,i,g){b(d.remote);d._tooltip("Autocomplete loading error, status: "+i+", error: "+g)})}},_renderItem:function(c,d){var b=(typeof d.detail!=="undefined"?d.detail:d.label);return a("<li>").attr("data-value",d.value).append(b).appendTo(c)},_removeIfInvalid:function(c,d){if(d.item){return}var g=this.input.val();var f=a.ui.autocomplete.escapeRegex(g);if(!this.options.readOnly){f="^"+f+"$"}var e=new RegExp(f,"i");if(this._setLastChoice(this.remote,e)){return false}if(this._setLastChoice(this.local(),e)){return false}if(this.options.readOnly){this.input.val("");this.element.val("");this.input.autocomplete("instance").term="";this._tooltip(g+(typeof lws_autocomplete_localize!=="undefined"?lws_autocomplete_localize.notMatch:" didn't match any items"))}else{var b={label:g,value:g};this.local().push(b);this.input.val(this._setOption(b).text())}},_setLastChoice:function(c,d){var b=a.map(c,function(e){if(e.value&&d.test(e.label)){return e}});if(b.length==1){this.input.val(this._setOption(b[0]).text());return true}return false},_tooltip:function(b){this.input.attr("title",b).tooltip("open");this._delay(function(){this.input.tooltip("close").attr("title","")},2500)},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);jQuery(function(a){a(".lws_autocomplete").lws_autocomplete()});