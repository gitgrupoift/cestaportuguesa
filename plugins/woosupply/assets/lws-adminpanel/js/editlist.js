(function(a){a.widget("lws.lws_editlist",{_create:function(){this._bindOn(this.element,"mouseenter",".lws_editlist_row_editable",this._showLineButtons);this._bindOn(this.element,"mouseleave",".lws_editlist_row_editable",this._hideLineButtons);this._bindOn(this.element,"click",".lws_editlist_item_add",this._addLine);this._bindOn(this.element,"click",".lws-editlist-btn-mod",this.editLine);this._bindOn(this.element,"click",".lws-editlist-btn-dup",this._copyLine);this._bindOn(this.element,"click",".lws-editlist-btn-del",this._removeLine);this._bindOn(this.element,"click","button.lws-editlist-btn-save",this._saveForm);this._bindOn(this.element,"click","button.lws-editlist-btn-cancel",this._cancelForm);this._bindOn(this.element,"change","input.lws_editlist_check_selectall",this.checkAll);this._bindOn(this.element,"click",".lws_editlist_group_add",this._addGroup);this._bindOn(this.element,"click",".lws_editlist_group_del",this._removeGroup);this._bindOn(this.element,"click",".lws_editlist_group_head_edit",this._editGroup);this._bindOn(this.element,"click",".lws_editlist_group_form_submit",this._submitEditGroup);this._bindOn(this.element,"click",".lws_editlist_group_form_cancel",this._cancelEditGroup);this.itemForm=this.element.find(".lws_editlist_line_form").prev().addBack();this.itemTemplate=this.element.find(".lws_editlist_template[data-line]");this.tableTemplate=this.element.find(".lws_editlist_table").clone(true);this.tableTemplate.find(".lws_editlist_table_body").empty();this.groupForm=this.element.find(".lws_editlist_groupby_settings>.lws_editlist_groupby_form").detach();this.element.removeClass("lws-editlist-renderer-grouped").addClass("lws-editlist-renderer-flatten");if(this.element.data("groupby")=="on"){setTimeout(this._bind(this.groupBy,this),0)}},_addGroup:function(){if(!this.isFormVisible()){var d=this.element.find(".lws_editlist_groups");var c=0;d.children(".lws_editlist_group").each(function(){var e=a(this).find(".lws_editlist_table .lws_editlist_table_body").attr("data-body");if(c<=e){c=(e+1)}});var b=this._appendNewNode(d,c);b.addClass("lws_editlist_node_trial_state");this._editGroup({target:b.find(".lws_editlist_groupby_head")})}return false},_removeGroup:function(d){if(!this.isFormVisible()&&confirm(lws_adminpanel.confirmDel)){var b=a(d.target).closest(".lws_editlist_group");this._removeItems(b.find(".lws_editlist_row_editable"),b.closest(".lws_editlist_groups"));var c=b.data("line");this.groupForm.detach();this.itemForm.detach();this.itemTemplate.detach();b.remove();this.element.trigger("group_deleted",lwsBase64.toObj(c),this)}return false},_editGroup:function(c){if(!this.isFormVisible()){if(this.groupForm.length>0){var b=a(c.target).closest(".lws_editlist_groupby_node");a(".lws_editlist_modal_edit_button").addClass("lws-editlist-btn-disabled");b.children(".lws_editlist_groupby_head").hide();b.append(this.groupForm);obj=lwsBase64.toObj(b.closest(".lws_editlist_group").data("line"));this.groupForm.lwsWriteForm(obj);this.resetBeforeUnload();this.groupForm.show().trigger("edit",obj,this);this.focusFirstField(this.groupForm)}}return false},_submitEditGroup:function(f){if(this.groupForm.is(":visible")&&this.groupForm.lwsMatchPattern()){var c=this.groupForm.closest(".lws_editlist_groupby_node");var b=c.children(".lws_editlist_groupby_head");var d=this.groupForm.lwsReadForm();this.groupForm.detach();this._spreadGroupedData(c.closest(".lws_editlist_group"),d);b.lwsWriteForm(d).show();c.closest(".lws_editlist_group").data("line",lwsBase64.fromObj(d)).removeClass("lws_editlist_node_trial_state").trigger("change",d,this);this.resetBeforeUnload();a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled")}return false},_cancelEditGroup:function(d){this.resetBeforeUnload();var c=a(d.target).closest(".lws_editlist_groupby_node");var b=c.closest(".lws_editlist_group");if(b.hasClass("lws_editlist_node_trial_state")&&b.find(".lws_editlist_row_editable[data-line]").length==0){this.groupForm.detach();this.itemForm.detach();this.itemTemplate.detach();b.remove()}else{b.removeClass("lws_editlist_node_trial_state");this.groupForm.detach();c.children(".lws_editlist_groupby_head").show()}a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled");return false},_getFormData:function(){var c=this.itemForm.lwsReadForm();var b=this.itemForm.closest(".lws_editlist_group[data-line]");if(b.length>0){a.each(lwsBase64.toObj(b.data("line")),function(d,e){c[d]=e})}return c},_spreadGroupedData:function(b,e){var c=b.find(".lws_editlist_row_editable[data-line]");if(this._mergeData(c,e)){var d=this;c.each(function(){var f=a(this);a.ajax({dataType:"json",url:lws_editlist_ajax_url,method:"POST",data:{method:"put",id:d.element.attr("id"),line:f.data("line"),groupedBy:d.isGroupedBy()?"true":""},success:function(g){if((0!=g)&&g.status&&(g.line!=undefined)){var h=lwsBase64.toObj(g.line);d._updateItemCells(f,h)}else{alert((0!=g)&&(g.error!=undefined)?g.error:lws_adminpanel.updateAlert)}}}).fail(function(i,j,g){var h="<div class='lws-error'>Update error, status: "+j+", error: "+g+"</div>";b.replaceWith(h)})})}},_mergeData:function(c,e){if(e==undefined){var b=c.first().closest(".lws_editlist_group[data-line]");if(b.length==0){return false}e=lwsBase64.toObj(b.data("line"))}var d=false;c.each(function(){var f=lwsBase64.toObj(a(this).data("line"));a.each(e,function(g,h){if(f[g]!=h){d=true;f[g]=h}});a(this).data("line",lwsBase64.fromObj(f))});return d},_filterGroupData:function(b){if(this.groupDataTemplate==undefined){var c={};this.element.find(".lws_editlist_groupby_settings").find("span[data-name],input[name],select[name],textarea[name]").each(function(){var d=a(this);if(d.prop("tagName").toUpperCase()=="SPAN"){c[d.data("name")]=d.html()}else{c[d.attr("name")]=d.val()}});this.groupDataTemplate=c}var c={};a.each(this.groupDataTemplate,function(d,e){c[d]=(b[d]==undefined?e:b[d])});return c},isGroupedBy:function(){return(this.isGrouped===true)},_splitTable:function(d,f){var g=a(f);var e=lwsBase64.toObj(g.data("line"));var c=e[this.groupKey];c=(c==undefined?"":c.replace(/\"/g,'\\"'));var b=this.groups.find('.lws_editlist_group[data-groupval="'+c+'"]');if(b.length==0){b=this._appendNewNode(this.groups,d,e,this.table,c)}b.find(".lws_editlist_table .lws_editlist_table_body").append(g)},_appendNewNode:function(e,c,d,f,b){var h=this._filterGroupData(d==undefined?{}:d);li=a("<div>",{"class":"lws_editlist_group lws-editlist-group","data-groupval":b==undefined?"":b,"data-line":lwsBase64.fromObj(h)});this.groupHead.clone(true).removeClass("lws_editlist_groupby_settings").addClass("lws-editlist-groupby-head lws_editlist_groupby_node").appendTo(li).lwsWriteForm(h).show();if(e.children().length==0){li.append((f==undefined||f.lenght==0)?this.tableTemplate.clone(true):f);if(this.addBtn.length>0){li.append(this.addBtn)}}else{var g=((f==undefined||f.lenght==0)?this.tableTemplate:f).clone(true);g.find(".lws_editlist_table_body").empty();li.append(g);if(this.addBtn.length>0){li.append(this.addBtn.clone(true))}}li.find(".lws_editlist_table .lws_editlist_table_body").attr("data-body",c);li.find(".lws_editlist_item_add").attr("data-body",c);e.append(li);return li},groupBy:function(d){this.groupHead=this.element.find(".lws_editlist_groupby_settings");if(this.groupHead.length==0){return}if(d==undefined){d=this.groupHead.data("groupby")}if(d==undefined){return}this.groupKey=d;a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled");this.itemForm.detach();this.itemTemplate.detach();this.flatten(true);this.addBtn=this.element.find(".lws_editlist_item_add");this.table=this.element.find(".lws_editlist_table");this.groups=this.element.find(".lws_editlist_groups");if(this.groups.length==0){this.groups=a("<div>",{"class":"lws_editlist_groups"}).insertBefore(this.table)}var b=this.table.find(".lws_editlist_row_editable[data-line]");if(b.length==0){this.table.remove();this.addBtn.remove()}else{b.each(this._bind(this._splitTable,this))}if(this.groupHead.data("add")!=undefined&&this.groupForm.length>0){var c=a("<button>",{"class":"lws-adm-btn lws-editlist-group-add lws_editlist_modal_edit_button lws_editlist_group_add","data-id":this.element.attr("id")}).append(a("<div>",{"class":"lws-group-add-icon lws-icon-plus"})).append(a("<div>",{"class":"lws-group-add-text"}).html(this.groupHead.data("add")));this.element.append(c)}this.groups=undefined;this.isGrouped=true;this.element.removeClass("lws-editlist-renderer-flatten").addClass("lws-editlist-renderer-grouped");this.element.trigger("grouped",this)},flatten:function(b){this._cancelForm();var c=this.element.find(".lws_editlist_groups");if(c.length>0){var d=this.tableTemplate.clone(true);d.find(".lws_editlist_table_body").empty();this.element.find(".lws_editlist_table .lws_editlist_table_body .lws_editlist_row_editable").each(function(){d.append(a(this))});d.insertAfter(c);if(this.addBtn.length>0){this.addBtn.clone(true).insertAfter(d)}a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled");this.itemForm.detach();this.itemTemplate.detach();this.groupForm.detach();c.remove();this.element.children(".lws_editlist_group_add").remove();this.element.find(".lws_editlist_table .lws_editlist_table_body").attr("data-body","");this.element.find(".lws_editlist_item_add").attr("data-body","")}this.isGrouped=false;this.element.removeClass("lws-editlist-renderer-grouped").addClass("lws-editlist-renderer-flatten");if(b!==true){this.element.trigger("flatten",this)}},checkAll:function(b){if(b===true){this.element.find("input.lws_editlist_check_selectitem").prop("checked",true)}else{if(b===false){this.element.find("input.lws_editlist_check_selectitem").prop("checked",false)}else{this.localTable(b.target).find("input.lws_editlist_check_selectitem").prop("checked",a(b.currentTarget).prop("checked"))}}},localTable:function(b){if(b==undefined){return this.element.find(".lws_editlist_table")}else{return a(b).closest(".lws_editlist_table")}},_bindOn:function(e,c,b,d){e.on(c,b,this._bind(d,this))},_bind:function(b,c){return function(){return b.apply(c,arguments)}},_showLineButtons:function(b){if(!this.isFormVisible()){a(b.currentTarget).find(".lws-editlist-buttons").css("visibility","visible")}},_hideLineButtons:function(b){a(b.currentTarget).find(".lws-editlist-buttons").css("visibility","hidden")},hideAllLinesButtons:function(){this.element.find(".lws-editlist-buttons").css("visibility","hidden")},isFormVisible:function(){return(a(".lws_editlist .lws_editlist_modal_form:visible").length>0)},editLine:function(b){if(!this.isFormVisible()){this._showForm(a(b.target))}return false},_copyLine:function(f){if(!this.isFormVisible()){var b=a(f.target).closest(".lws_editlist_row_editable");var d=lwsBase64.toObj(b.data("line"));d[this.localTable(f.target).attr("uid")]="";var c=b.clone(true).removeAttr("id").data("template",1);c.find(".lws-editlist-buttons").remove();c.data("line",lwsBase64.fromObj(d));this._showForm(c.insertBefore(b))}return false},_removeLine:function(c){if(!this.isFormVisible()&&confirm(lws_adminpanel.confirmDel)){var b=a(c.target).closest(".lws_editlist_row_editable");if(b.length>0){this._removeItems(b)}}return false},_removeItems:function(b,c){var d=this;b.each(function(){var g=a(this);var f=(c==undefined?g:c);var e=g.data("line");a.ajax({dataType:"json",url:lws_editlist_ajax_url,method:"POST",data:{method:"del",id:d.element.attr("id"),line:e,groupedBy:d.isGroupedBy()?"true":""},success:function(h){if((0!=h)&&h.status){g.remove()}else{f.replaceWith("<p class='lws-error'>Erase error.</p>")}d.element.trigger("deleted",lwsBase64.toObj(e),this)}}).fail(function(i,j,h){f.replaceWith("<p class='lws-error'>Erase error, status: "+j+", error: "+h+"</p>")})})},_addLine:function(d){if(!this.isFormVisible()){var b=this.itemTemplate.clone(true);b.removeAttr("id").addClass("lws_editlist_row_editable").removeClass("lws_editlist_template");var c='.lws_editlist_table .lws_editlist_table_body[data-body="'+a(d.currentTarget).attr("data-body")+'"]';this.element.find(c).append(b);this._mergeData(b);this._showForm(b)}return false},_showForm:function(c){c=c.closest(".lws_editlist_row_editable").addClass("lws_editlist_tr_edited");this.itemForm.insertAfter(c.hide());var b=c.data("line");var f=((b==undefined||b.trim()=="")?{}:lwsBase64.toObj(b));try{this.itemForm.lwsWriteForm(f,true)}catch(d){console.log(d)}a(".lws_editlist_modal_edit_button").addClass("lws-editlist-btn-disabled");this.resetBeforeUnload();this.itemForm.show().trigger("edit",f,this);this.focusFirstField(this.itemForm)},_saveForm:function(){var b=this.element.find(".lws_editlist_tr_edited");a.ajax({dataType:"json",url:lws_editlist_ajax_url,method:"POST",data:{method:"put",id:this.element.attr("id"),line:lwsBase64.fromObj(this._getFormData()),groupedBy:this.isGroupedBy()?"true":""},success:this._bind(this._savedCallback,this)}).fail(function(f,g,c){var e="<p class='lws-error'>Update error, status: "+g+", error: "+c+"</p>";b.removeClass("lws_editlist_tr_edited").replaceWith(e).show()});return false},_savedCallback:function(b){if((0!=b)&&b.status&&(b.line!=undefined)){var d=lwsBase64.toObj(b.line);var c=this.element.find(".lws_editlist_tr_edited").removeClass("lws_editlist_tr_edited").data("line",b.line).removeData("template").removeAttr("data-template");this._updateItemCells(c,d,true);c.show();this.itemForm.hide().detach();a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled");this.showInfo(b.message);this.resetBeforeUnload();c.trigger("updated",d,this)}else{alert((0!=b)&&(b.error!=undefined)?b.error:lws_adminpanel.updateAlert)}},_updateItemCells:function(d,e,b){var c=this.itemTemplate;d.find(".lws_editlist_td").each(function(f,i){i=a(i);var g=i.data("key");if((g!=undefined)&&(e[g]!=undefined)){var h=i.find(".lws-editlist-buttons").detach();if(h.length<=0){h=c.find('.lws_editlist_td[data-key="'+g+'"]').find(".lws-editlist-buttons").clone(true)}i.html(e[g]);if(h.length>0){i.append("<br/>",h)}if(b===true){i.trigger("change",e,this)}}})},showInfo:function(b){if(b!=undefined){alert(b)}},_cancelForm:function(){var b=this.element.find(".lws_editlist_tr_edited").removeClass("lws_editlist_tr_edited");if(b.length>0){if(b.data("template")=="1"){b.remove()}else{b.show()}}a(".lws_editlist_modal_edit_button").removeClass("lws-editlist-btn-disabled");this.itemForm.hide().detach();this.resetBeforeUnload();return false},resetBeforeUnload:function(){if(window.lwsInputchanged!==true){window.onbeforeunload=undefined}},focusFirstField:function(b){setTimeout(function(){b.find("input:visible, select:visible, textarea:visible").first().focus().select()},10)}})})(jQuery);jQuery(function(a){a(".lws_editlist").lws_editlist()});