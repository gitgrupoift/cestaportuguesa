(function(a){a.widget("lws.lac_model",{options:{mode:"autocomplete",origin:undefined,count:20},_create:function(){this.originsList=[];this.currentOrigin={};this.keySource={};this.labelSource={};this.dataSource={};this.showMore=false;a.ajaxSettings.cache=false;this._setSource()},_bind:function(b,c,d){return function(){return b.apply(c,d)}},_setSource:function(){var b=a(this.options.origin.element);this.dataSource={};this.origdataSource={};this.ajax={};this.rawSource=undefined;if(b[0].nodeName=="SELECT"){for(var d=0;d<b[0].options.length;d++){var f={};f.value=b[0].options[d].value;f.label=b[0].options[d].text;if(b[0].options[d].closest("optgroup")!=null){var g=b[0].options[d].closest("optgroup").label;if(this.dataSource[g]==undefined){this.dataSource[g]={};this.dataSource[g].label=g;this.dataSource[g].group={};this.origdataSource[g]={};this.origdataSource[g].label=g;this.origdataSource[g].group={}}this.dataSource[g].group[d]=f;this.origdataSource[g].group[d]=f;this.keySource[b[0].options[d].value]=d}else{this.dataSource[d]=f;this.keySource[b[0].options[d].value]=d}}}if(this.options.origin.options.source!=undefined){this.rawSource=this.options.origin.options.source}if(b.data("source")!=undefined&&b.data("source")!=""){this.rawSource=lwsBase64.toObj(b.data("source"))}if(this.rawSource!=undefined){var c=0;var e=this;a.each(this.rawSource,function(h,j){e.dataSource[c]=j;e.keySource[j.value]=c;e.labelSource[j.label]=c;c+=1})}if(this.options.origin.options.ajax!=undefined){this.showMore=true;this.ajax.action=this.options.origin.options.ajax}if(b.data("ajax")!=undefined){this.showMore=true;this.ajax.action=b.data("ajax")}if(this.options.origin.options.spec!=undefined){this.ajax.spec=this.options.origin.options.spec}if(b.data("sourceurl")!=undefined){this.ajax.sourceurl=b.data("sourceurl")}if(this.options.origin.options.minsearch!=undefined){this.options.minsearch=this.options.origin.options.minsearch}if(b.data("minsearch")!=undefined){this.options.minsearch=b.data("minsearch")}if(this.options.origin.options.minoption!=undefined){this.options.minoption=this.options.origin.options.minoption}if(b.data("minoption")!=undefined){this.options.minoption=b.data("minoption")}if(this.options.origin.options.minlength!=undefined){this.options.minlength=this.options.origin.options.minlength}if(b.data("minlength")!=undefined){this.options.minlength=b.data("minlength")}},_setOrigin:function(b){var c=b.uuid;if(this.originsList[c]==""||this.originsList[c]==undefined){this.originsList[c]={};this.originsList[c].resLoad=b.resLoad;this.originsList[c].resChange=b.resChange;this.originsList[c].target=b;this.originsList[c].searched="";this.originsList[c].page=0;this.originsList[c].count=this.options.count}this.currentOrigin=this.originsList[c]},reInit:function(b){this._setOrigin(b);this.currentOrigin.page=0;this._setSource()},showMoreResults:function(b){this._setOrigin(b);this.currentOrigin.page+=1;this._remoteSource(this.currentOrigin.searched)},returnLabels:function(b,d,f){this.resCount=0;if(d!=undefined&&d!=""){this._setOrigin(d)}result=[];if(b!=undefined&&b!==false&&b.length>0&&b[0]!=""&&b[0]!=null){this.resCount=b.length;result=this._recursiveSearch(b,this.dataSource,true);if(this.resCount>0){if((this.ajax.sourceurl!=undefined&&this.ajax.sourceurl!="")||(this.ajax.action!=undefined&&this.ajax.action!="")){this._remoteSource(b,"init",true,true)}}var e=Object.keys(this.dataSource).length;for(let i=0;i<b.length;i++){var c=this.keySource[b[i]];if(c==undefined){result[b[i]]={};result[b[i]].value=b[i];result[b[i]].label=b[i];result[b[i]].html="";this.dataSource[e]=result[b[i]];this.keySource[b[i]]=e;this.labelSource[b[i]]=e;e+=1}}}this._sendBack(result,"init")},isSubChain:function(c,b){if(b!=undefined&&b!=""){this._setOrigin(b)}if(this.currentOrigin.searched.toLowerCase().substring(0,c.length)==c.toLowerCase()&&c.length<this.currentOrigin.searched.length){return true}return false},getValuesFromLabels:function(b,c){result=[];for(let i=0;i<b.length;i++){res=this.dataSource[this.labelSource[b[i]]];if(res==undefined||res==""){if(c==undefined||!c){res={};res.value=b[i];res.label=b[i];res.html="";result.push(res);this.dataSource[Object.keys(this.dataSource).length]=res}}else{result.push(res)}}return result},research:function(c,b,d){if((c==""||c==undefined)&&(d==undefined||d==false)){return}if(b!=undefined&&b!=""){this._setOrigin(b)}if(d==true){if(this.ajax.action!=undefined){this._remoteSource("")}else{this._sendBack(this.dataSource,"ok")}}else{if(c.length<this.options.minlength){return}if(c.toLowerCase().substring(0,this.currentOrigin.searched.length)==this.currentOrigin.searched.toLowerCase){resultData=this._recursiveSearch(c,this.dataSource,false);this._sendBack(resultData,"ok")}else{this.currentOrigin.searched=c;if(c.length>this.options.minsearch&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{resultData=this._recursiveSearch(c,this.dataSource,false);if(resultData.length<this.options.minoption&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{this._sendBack(resultData,"ok")}}}}},getSource:function(){return this.dataSource},addToSource:function(d){var b=Object.keys(this.dataSource).length;for(var c in d){if(this.keySource[c]==""||this.keySource[c]==undefined){res={};res.value=d[c];res.label=d[c];res.html="";res.parent="";this.dataSource[b]=res;this.keySource[res.value]=b;this.labelSource[res.label]=b}}},clone:function(d){if(d==null||typeof(d)!="object"){return d}var b=new d.constructor();for(var c in d){b[c]=this.clone(d[c])}return b},_recursiveSearch:function(g,f,c){var b={};if(Object.keys(f).length==0){return b}for(var e in f){this.keySource[f[e].value]=e;this.labelSource[f[e].label]=e;if(f[e].group!=undefined){retour={};retour=this._recursiveSearch(g,f[e].group,c);if(!jQuery.isEmptyObject(retour)){b[e]=this.clone(f[e]);b[e].group=retour}}else{if(c==true){for(var d=0;d<g.length;d++){if(g[d]==f[e].value){b[e]=this.clone(f[e]);this.resCount-=1}}}else{researched=f[e].label.toLowerCase();if(a.isArray(g)){for(let d=0;d<g.length;d++){if(this.options.mode=="autocomplete"){if(researched.substring(0,g.length)==g[d].toLowerCase()){b[e]=this.clone(f[e]);this.resCount-=1}}else{if(this.options.mode=="research"){if(researched.search(g.toLowerCase())!=-1){b[e]=this.clone(f[e]);this.resCount-=1}}}}}else{if(this.options.mode=="autocomplete"){if(researched.substring(0,g.length)==g.toLowerCase()){b[e]=this.clone(f[e])}}else{if(this.options.mode=="research"){if(researched.search(g.toLowerCase())!=-1){b[e]=this.clone(f[e])}}}}}}}return b},_sendBack:function(c,b){result=[c,b,this.showMore];if(this.currentOrigin.resChange!=undefined){this.currentOrigin.resChange.fn.apply(this.currentOrigin.target,[result])}},_remoteSource:function(f,b,d){if(this.currentOrigin.resLoad!=undefined){this.currentOrigin.resLoad.fn.apply(this.currentOrigin.target)}var c={action:this.ajax.action,term:f,fromValue:d,count:this.currentOrigin.count,page:this.currentOrigin.page};if(b=="init"){c.term=""}c.fromValue=undefined;if(this.currentOrigin.target.element.data("spec")!=undefined){c.spec=this.currentOrigin.target.element.data("spec")}ajax_url=(this.ajax.sourceurl!=undefined)?this.ajax.sourceurl:lws_ajax_url;var e=this;a.getJSON(ajax_url,c,function(g){resultData={};if(null==g){status="Autocomplete ressource error."}else{if(0===g){status="Autocomplete action not found."}else{var h=Object.keys(e.dataSource).length;a.each(g,function(k,l){var j=e.keySource[l.value];if(j==undefined){e.dataSource[h]=l;e.keySource[l.value]=h;e.labelSource[l.label]=h;h+=1}else{e.dataSource[j]=l;e.labelSource[l.label]=j}});e.showMore=(Object.keys(g).length==e.currentOrigin.count);if(b!=undefined){status="init";e.resCount=f.length;resultData=e._recursiveSearch(f,e.dataSource,true);if(e.resCount>0){console.log("some items couldn't be found on datasource")}}else{status="ok";e.currentOrigin.searched=f;resultData=e._recursiveSearch(f,e.dataSource,false)}e._sendBack(resultData,status)}}}).fail(function(h,j,g){resultData=[];status="Autocomplete loading error, status: "+j+", error: "+g;e._sendBack(resultData,status)})}})})(jQuery);